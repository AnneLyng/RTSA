---
title: "One-sided TSA"
output: 
  bookdown::html_document2:
    fig_caption: yes
vignette: >
  %\VignetteIndexEntry{one-sided}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction
 
This vignette is a supporting guide for boundaries in the RTSA package for one-sided tests. We will focus on $\alpha$-spending boundaries with and without $\beta$-spending boundaries. No $\beta$-spending boundaries means no futility boundaries. Including $\beta$-spending boundaries means adding either: binding or non-binding futility boundaries. There will be an example of a one-sided TSA in the end of the vignette.

As TSA combines meta-analysis with group sequential methods, we start with producing a one-sided meta-analysis. After, we will introduce the different sequential designs to consider when creating a sequential one-sided testing scheme. 

# Setup

We need the following two libraries for this vignette. 

```{r message=FALSE}
library(RTSA)
library(ggplot2)
```

We will use a data example which is included in the RTSA package called perioOxy. TODO: more about the example.

```{r}
data("perioOxy")
head(perioOxy)
```

# Traditional meta-analysis 

A traditional meta-analysis (non-sequential meta-analysis) can be computed in RTSA. Besides providing the trials to be synthesized, we specify the kind of test, type-1- and type-2-error levels etc. In our example, we have the following set-up: 

- One-sided test
- Outcome metric is Relative Risk/Risk Ratio (RR)
- Method of weighting is Inverse Variance (IV)
- $\alpha=0.025$, which is the default type-1-error with one-sided testing
- $\beta=0.2$, which is the default type-2-error

We will need to specify the decided test type, the type-1-error level $\alpha$ and type-2-error level $\beta$ often. We define the variables globally. 

```{r}
side <- 1
alpha <- 0.025
beta <- 0.2
```

The function `metaanalysis` in `RTSA` calculates a standard meta-analysis. The function returns study level statistics such as study specific estimates, confidence intervals etc. It also returns the meta-analysis statistics. The results are shown in the default print but can also be printed separately. For the results on the heterogeneity such as $\tau^2$ it is located in `heteResults`, which can be extracted from the meta-analysis object. Note that if `heteResults` is NULL, we were not able to estimate any heterogeneity. 

```{r}
metaanalysis(outcome = "RR", method = "IV", side = side, alpha = alpha, beta = beta, data = perioOxy)
ma <- metaanalysis(outcome = "RR", method = "IV", side = side, alpha = alpha, beta = beta, data = perioOxy)
ma$studyResults
ma$metaResults
ma$heteResults
```

A forest-plot can be generated for the meta-analysis output:

```{r}
plot(ma)
```

# TSA: Trial sequential analysis

Suppose that the meta-analysis above was not performed once, but repeatedly as the trials were reported. In a naive analysis, the type-1-error would be inflated had the meta-analysis been calculated sequentially. To control type-1-error, one can impose a sequential design. TSA can illustrate whether we would have had the same conclusion had the hypothesis test been made in a sequential design. 

Some things to consider before creating TSA are the type of test, definition of the information size and timing of meta-analyses. These three will be explained in more detail in the other vignettes. Below are some summarized points.

- Type of test

We use the same kind of test with specified error rates as before in the traditional meta-analysis. However, we can also decide on whether we would like to have futility boundaries. See the vignette, "Futility", for more information about futility boundaries. 

- Definition of the information size

The sequential analysis divides the type-1-error across an interval ranging from of the first meta-analysis to a final cumulative meta-analysis. Here the final cumulative meta-analysis refers to a meta-analysis achieving the specified level of power. The range is often defined by the sample size accrued over the repeated meta-analysis. The scale of the interval is in TSA, and many other sequential methods, defined from 0 to 1. Here 0 could be equal to a sample size of 0 and 1 would then be the required information/sample size for a certain level of power. When defined from 0 to 1, the interval can be denoted as the information fraction accrued during the cumulative meta-analysis. 

The naive or traditional meta-analysis of the data example provides information about a fixed-effect and random-effects meta-analysis. It does however not mention the level of power or if the meta-analysis reaches the sample size requirement. If you are interested in power calculations and required information size. We recommend that you read the vignette: "Calculating required sample size and required number of trials". 

Our required information size (RIS) is calculated to:

```{r}
# Calculate the cumulative number of participants
count <- cumsum(perioOxy$nI+perioOxy$nC)
# Calculate the RIS 
mcv_RR = 0.65
p0 = sum(perioOxy$eC+perioOxy$eI)/sum(perioOxy$nC+perioOxy$nI)
pI = exp(log(p0)+log(mcv_RR)/2)
pC = exp(log(p0)-log(mcv_RR)/2)
RIS = RTSA:::nRandom(alpha = alpha*2/side, beta = 0.2, pI = pI, pC = pC,
                     diversity = 0.79)
ceiling(RIS)
```
- Timing of the meta-analyses

Based on RIS, we set the information fractions to the fraction of number of participants per meta-analysis out of RIS.

```{r}
# Set the timings of the studies relative to the RIS
inf_frac <- c(count/RIS,1)
inf_frac
```

We will consider three different one-sided designs. These are respectively: One-sided testing wit no futility, one-sided testing with non-binding futility and one-sided testing with binding futility. 

## One-sided test with no futility

By specifying `side = 1`, we have a one-sided test. Per default does the `RTSA` function assume no futility boundaries. 

We can get information about the boundaries and the test statistics from the `RTSA` output:

```{r}
RTSAout <- RTSA(data = perioOxy, outcome = "RR", mc = 0.65, side = 1, alpha = 0.025, 
                beta = 0.2)
RTSAout$boundout
RTSAout$zvalues
```

We can also plot the one-sided TSA:

```{r fig.align = 'center'}
plot(RTSAout)
```


## One-sided test and non-binding futility

By using the same specifications as before but including `futility = "non-binding"`, we create a one-sided test design with non-binding futility. 

```{r}
RTSAout_nb <- RTSA(data = perioOxy, outcome = "RR", mc = 0.65, side = side, alpha = alpha, 
                   beta = beta, futility = "non-binding")
```

Again, can we plot the RTSA object: 

```{r fig.align = 'center'}
plot(RTSAout_nb)
```

Note that we require more participants in the non-binding futility design compared to the one-sided design with no futility. 

## One-sided test and binding futility

By using the same specifications as before but including `futility = "binding"`, we create a one-sided test design with binding futility. 

```{r}
RTSAout_b <- RTSA(data = perioOxy, outcome = "RR", mc = 0.65, side = side, alpha = alpha, 
                   beta = beta, futility = "binding")
```

Again, can we plot the RTSA object: 

```{r fig.align = 'center'}
plot(RTSAout_b)
```

Note that the DARIS is smaller for binding futility compared to non-binding futility. We also have less conservative tests as the $\alpha$ spending boundary is less extreme compared to both the non-binding futility design and the design completely without futility. 
